<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoca Royale</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1c2128 0%, #2a3038 50%, #1c2128 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #f4f8ff;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 122, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 122, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        .casino-lights {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                #007aff 0%, #0056b3 25%, #007aff 50%, 
                #0056b3 75%, #007aff 100%);
            background-size: 200% 100%;
            animation: lights 3s linear infinite;
            box-shadow: 0 2px 20px rgba(0, 122, 255, 0.5);
        }

        @keyframes lights {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .header {
            text-align: center;
            margin: 40px 0 30px;
            z-index: 10;
            position: relative;
        }

        .header h1 {
            font-size: 4.5em;
            font-weight: 300;
            letter-spacing: 8px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f4f8ff 0%, #007aff 50%, #f4f8ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            text-shadow: 0 0 40px rgba(0, 122, 255, 0.3);
        }

        .subtitle {
            font-size: 1em;
            color: #8a9199;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 500;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            background: rgba(244, 248, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 122, 255, 0.3);
            border-radius: 30px;
            margin-top: 20px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        .status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .main-container {
            display: flex;
            gap: 50px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 1600px;
            z-index: 10;
            position: relative;
        }

        .roulette-table {
            background: linear-gradient(145deg, #242a32 0%, #1c2128 100%);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(0, 122, 255, 0.1),
                inset 0 1px 0 rgba(244, 248, 255, 0.05);
            position: relative;
        }

        .wheel-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .wheel-container {
            position: relative;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #1c2128 0%, #0f1114 100%);
            border-radius: 50%;
            padding: 20px;
            box-shadow: 
                inset 0 0 60px rgba(0, 0, 0, 0.8),
                0 0 80px rgba(0, 122, 255, 0.2);
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 0 40px rgba(0, 122, 255, 0.3),
                inset 0 0 30px rgba(0, 0, 0, 0.5);
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
            border: 2px solid rgba(244, 248, 255, 0.1);
            background: conic-gradient(from 0deg, #1c2128, #2a3038);
        }

        .wheel.spinning {
            transition: transform 4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .wheel-number {
            position: absolute;
            inset:0;
            transform-origin:50% 50%;
            width: 50%;
            height: 50%;
            transform-origin: right bottom;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-display {
            position: absolute;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            border: 2px solid rgba(244, 248, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            color: #f4f8ff;
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.5),
                inset 0 -2px 5px rgba(0, 0, 0, 0.3);
            transform: rotate(var(--rotate)) translateX(180px) rotate(calc(-1 * var(--rotate)));
            transition: all 0.3s ease;
        }

        .number-display.highlighted {
            transform: rotate(var(--rotate)) translateX(180px) rotate(calc(-1 * var(--rotate))) scale(1.5);
            background: linear-gradient(135deg, #00d4ff 0%, #007aff 100%);
            box-shadow: 
                0 0 30px rgba(0, 212, 255, 0.8),
                0 2px 10px rgba(0,0,0,0.5),
                inset 0 -2px 5px rgba(0,0,0,0.3);
            animation: glow 1s ease-in-out infinite alternate;
            z-index: 100;
            border-color: #f4f8ff;
        }

        @keyframes glow {
            from { box-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 2px 10px rgba(0,0,0,0.5); }
            to { box-shadow: 0 0 50px rgba(0, 212, 255, 1), 0 2px 10px rgba(0,0,0,0.5); }
        }

.participant-name{
  position:absolute;
  width:140px;                 /* give room for centering */
  margin-left:-70px;           /* center the 140px box on the anchor */
  left:50%;
  text-align:center;
  transform: rotate(var(--rotate)) translateX(140px) rotate(calc(-1 * var(--rotate)));
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
        .participant-name.highlighted {
            font-size: 14px;
            font-weight: 600;
            color: #00d4ff;
            text-shadow: 
                0 0 10px rgba(0, 212, 255, 0.8),
                1px 1px 2px rgba(0,0,0,0.8);
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            border-radius: 50%;
            border: 3px solid rgba(244, 248, 255, 0.9);
            box-shadow: 
                0 0 40px rgba(0, 122, 255, 0.5),
                inset 0 -3px 10px rgba(0,0,0,0.3);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: #f4f8ff;
            letter-spacing: 2px;
            text-transform: uppercase;
            user-select: none;
        }

        .pointer {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 50px solid #00d4ff;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
            z-index: 11;
            animation: bounce 2s infinite;
        }

        .pointer::after {
            content: '';
            position: absolute;
            top: -50px;
            left: -10px;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #00d4ff 0%, #007aff 100%);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .info-panels {
            display: flex;
            flex-direction: column;
            gap: 25px;
            min-width: 400px;
        }

        .panel {
            background: linear-gradient(145deg, #242a32 0%, #1c2128 100%);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 10px 40px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(244, 248, 255, 0.05);
            position: relative;
        }

        .panel h2 {
            margin-bottom: 25px;
            font-size: 1.5em;
            font-weight: 300;
            color: #f4f8ff;
            letter-spacing: 2px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(28, 33, 40, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(0, 122, 255, 0.1);
        }

        .participant-slot {
            background: linear-gradient(135deg, #2a3038 0%, #1c2128 100%);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .participant-slot:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 122, 255, 0.3);
            border-color: #007aff;
            background: linear-gradient(135deg, #2e343d 0%, #20252c 100%);
        }

        .participant-slot.highlighted {
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            border-color: #00d4ff;
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.6);
            animation: pulse-highlight 1s ease-in-out infinite;
        }

        @keyframes pulse-highlight {
            0%, 100% { transform: scale(1.1); }
            50% { transform: scale(1.15); }
        }

        .slot-number {
            font-size: 24px;
            font-weight: 600;
            color: #007aff;
            margin-bottom: 5px;
        }

        .slot-name {
            font-size: 11px;
            color: rgba(244, 248, 255, 0.8);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .participant-slot.highlighted .slot-number,
        .participant-slot.highlighted .slot-name {
            color: #f4f8ff;
        }

        .queue-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(28, 33, 40, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(0, 122, 255, 0.1);
        }

        .queue-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .queue-item {
            padding: 10px 18px;
            background: linear-gradient(135deg, #2a3038 0%, #1c2128 100%);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 25px;
            font-size: 14px;
            color: rgba(244, 248, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .queue-position {
            background: rgba(0, 122, 255, 0.2);
            color: #00d4ff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .winner-announcement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(145deg, #242a32 0%, #1c2128 100%);
            padding: 60px;
            border-radius: 30px;
            border: 2px solid #007aff;
            box-shadow: 
                0 30px 100px rgba(0,0,0,0.8),
                0 0 150px rgba(0, 122, 255, 0.4),
                inset 0 1px 0 rgba(244, 248, 255, 0.1);
            z-index: 1000;
            text-align: center;
            display: none;
        }

        .winner-announcement.show {
            display: block;
            animation: winnerPop 0.5s ease forwards;
        }

        @keyframes winnerPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(180deg); }
            60% { transform: translate(-50%, -50%) scale(1.1) rotate(-10deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }

        .winner-text {
            font-size: 1.2em;
            color: #8a9199;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 300;
        }

        .winner-number {
            font-size: 5em;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff 0%, #007aff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(0, 122, 255, 0.5);
            margin: 20px 0;
        }

        .winner-name {
            font-size: 2.5em;
            font-weight: 300;
            color: #f4f8ff;
            margin: 20px 0;
            letter-spacing: 2px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear;
            pointer-events: none;
        }

        @keyframes confetti-fall {
            0% { 
                transform: translateY(-100vh) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(100vh) rotate(720deg); 
                opacity: 0; 
            }
        }

        .spinning-indicator {
            display: none;
            background: linear-gradient(135deg, #00d4ff 0%, #007aff 100%);
            color: #f4f8ff;
            padding: 15px 40px;
            border-radius: 30px;
            position: absolute;
            bottom: -70px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 5px 30px rgba(0, 122, 255, 0.5);
            animation: pulse-spin 1s infinite;
        }

        @keyframes pulse-spin {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        .spinning-indicator.show {
            display: block;
        }

        .user-highlight-banner {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            padding: 18px 40px;
            border-radius: 40px;
            border: 1px solid rgba(244, 248, 255, 0.3);
            box-shadow: 0 10px 40px rgba(0, 122, 255, 0.4);
            z-index: 1000;
            display: none;
            animation: slideDown 0.5s ease;
        }

        .user-highlight-banner.show {
            display: block;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .highlight-text {
            font-size: 1.1em;
            font-weight: 500;
            color: #f4f8ff;
            letter-spacing: 1px;
        }

        .highlight-number {
            font-size: 2em;
            margin: 0 15px;
            font-weight: 700;
            color: #f4f8ff;
            text-shadow: 0 0 10px rgba(244, 248, 255, 0.5);
        }

        .error-message {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            padding: 15px 25px;
            border-radius: 10px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f4f8ff;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .error-message.show {
            display: block;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(28, 33, 40, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00d4ff 0%, #007aff 100%);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                gap: 30px;
            }
            
            .wheel-container {
                width: 350px;
                height: 350px;
            }
            
            .info-panels {
                min-width: auto;
                width: 100%;
                max-width: 400px;
            }
            
            .header h1 {
                font-size: 2.5em;
                letter-spacing: 4px;
            }
            
            .participants-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="casino-lights"></div>
    
    <div class="header">
        <h1>Avoca Royale</h1>
        <div class="subtitle">Where Fortune Meets Destiny</div>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="connectionStatus">Connecting...</span>
        </div>
    </div>

    <div class="user-highlight-banner" id="userBanner">
        <div class="highlight-text">
            Your Number: <span class="highlight-number" id="userNumber">-</span>
            Good Luck, <span id="userName">Player</span>!
        </div>
    </div>

    <div class="main-container">
        <div class="roulette-table">
            <div class="wheel-section">
                <div class="wheel-container">
                    <div class="pointer"></div>
                    <div class="wheel" id="wheel"></div>
                    <div class="wheel-center">SPIN</div>
                    <div class="spinning-indicator" id="spinningIndicator">Spinning...</div>
                </div>
            </div>
        </div>

        <div class="info-panels">
            <div class="panel">
                <h2>Players (<span id="participantCount">0</span>/36)</h2>
                <div class="participants-grid" id="participantsGrid">
                    <div style="grid-column: 1 / -1; text-align: center; color: #8a9199; padding: 40px 20px;">
                        Waiting for players to join...
                    </div>
                </div>
                
                <div class="queue-section" id="queueSection" style="display: none;">
                    <h3 style="color: #f4f8ff; margin-bottom: 15px; font-weight: 300; letter-spacing: 1px;">WAITING LIST (<span id="queueCount">0</span>)</h3>
                    <div class="queue-list" id="queueList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="winner-announcement" id="winnerAnnouncement">
        <div class="winner-text">Winner</div>
        <div class="winner-number" id="winnerNumber">00</div>
        <div class="winner-name" id="winnerName"></div>
        <div style="font-size: 1.1em; color: #8a9199; margin-top: 20px; letter-spacing: 2px;">CONGRATULATIONS</div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <script>
        // ============================================================================
        // CONFIGURATION - Update these values as needed
        // ============================================================================
        const AIRTABLE_CONFIG = {
            API_KEY: 'patjFd8AqLFaguOEe.0926a467696986c2920b20907d6f7b8bc468592117c50e02d4303fbc29eb0ac1',
            BASE_ID: 'appQm84VJgrmPJZal',
            PARTICIPANTS_TABLE: 'Participants',
            ADMIN_TABLE: 'Admin Controls',
            POLLING_INTERVAL: 500 // .5sec
        };

        // ============================================================================
        // GLOBAL STATE
        // ============================================================================
        let appState = {
            participants: [],
            queue: [],
            isSpinning: false,
            highlightedUser: null,
            lastSpinCheck: null,
            currentSpinId: null,
            connectionStatus: 'connecting'
        };

        // URL Parameters
        const urlParams = new URLSearchParams(window.location.search);
        const userEmail = urlParams.get('email');
        const userName = urlParams.get('name');

        // Wheel segment colors (alternating dark blue and lighter variations)
        const wheelColors = [
            '#007aff', '#0056b3', '#003d80', '#004c99', 
            '#0066cc', '#0052a3', '#003366', '#004080',
            '#0059b3', '#003f7f', '#004d99', '#0066cc',
            '#007aff', '#0056b3', '#003d80', '#004c99',
            '#0066cc', '#0052a3', '#003366', '#004080',
            '#0059b3', '#003f7f', '#004d99', '#0066cc',
            '#007aff', '#0056b3', '#003d80', '#004c99',
            '#0066cc', '#0052a3', '#003366', '#004080',
            '#0059b3', '#003f7f', '#004d99', '#0066cc'
        ];

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function showError(message) {
            console.error('Error:', message);
            const errorEl = $('#errorMessage');
            errorEl.text(message).addClass('show');
            setTimeout(() => {
                errorEl.removeClass('show');
            }, 5000);
        }

        function updateConnectionStatus(status) {
            appState.connectionStatus = status;
            const statusEl = $('#connectionStatus');
            const dotEl = $('#statusDot');
            
            switch(status) {
                case 'connected':
                    statusEl.text('Connected');
                    dotEl.removeClass('disconnected');
                    break;
                case 'error':
                    statusEl.text('Connection Error');
                    dotEl.addClass('disconnected');
                    break;
                default:
                    statusEl.text('Connecting...');
                    dotEl.removeClass('disconnected');
            }
        }

        function createConfetti() {
            const colors = ['#007aff', '#00d4ff', '#f4f8ff', '#0056b3'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = $('<div class="confetti"></div>');
                    confetti.css({
                        left: Math.random() * 100 + 'vw',
                        backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                        borderRadius: Math.random() > 0.5 ? '50%' : '0',
                        animationDelay: Math.random() * 3 + 's'
                    });
                    $('body').append(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        // ============================================================================
        // AIRTABLE API FUNCTIONS
        // ============================================================================
        
        async function fetchFromAirtable(tableName, params = {}) {
            try {
                // Build URL with proper encoding for Airtable API
                let url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.BASE_ID}/${tableName}`;
                const searchParams = new URLSearchParams();
                
                // Handle each parameter properly
                Object.entries(params).forEach(([key, value]) => {
                    if (key === 'sort' && Array.isArray(value)) {
                        // Sort parameter needs special handling
                        value.forEach(sortObj => {
                            searchParams.append('sort[0][field]', sortObj.field);
                            searchParams.append('sort[0][direction]', sortObj.direction);
                        });
                    } else if (typeof value === 'string' || typeof value === 'number') {
                        searchParams.append(key, value);
                    }
                });
                
                if (searchParams.toString()) {
                    url += '?' + searchParams.toString();
                }
                
                console.log('Fetching from URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Airtable API Error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.records || [];
            } catch (error) {
                console.error(`Error fetching from ${tableName}:`, error);
                throw error;
            }
        }

        async function updateAirtableRecord(tableName, recordId, fields) {
            try {
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.BASE_ID}/${tableName}/${recordId}`;
                
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fields })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`Error updating record in ${tableName}:`, error);
                throw error;
            }
        }

        // ============================================================================
        // DATA PROCESSING FUNCTIONS
        // ============================================================================
        
        async function fetchParticipants() {
            try {
                // Simplify the query to avoid encoding issues
                const records = await fetchFromAirtable(AIRTABLE_CONFIG.PARTICIPANTS_TABLE, {
                    filterByFormula: "OR({Status} = 'Active', {Status} = '')",
                    maxRecords: 100
                });

                const participants = records.map(record => ({
                    id: record.id,
                    name: record.fields.Name || 'Anonymous',
                    email: record.fields.Email || '',
                    weight: record.fields.Weight || 1,
                    status: record.fields.Status || 'Active'
                }));

                // Sort by weight (higher weight = better position), then by name
                participants.sort((a, b) => {
                    if (b.weight !== a.weight) {
                        return b.weight - a.weight;
                    }
                    return a.name.localeCompare(b.name);
                });

                return participants;
            } catch (error) {
                console.error('Error fetching participants:', error);
                return [];
            }
        }

let lastSpinIdSeen = null;

async function checkSpinTrigger(){
  try{
    const records = await fetchFromAirtable(AIRTABLE_CONFIG.ADMIN_TABLE, {
      filterByFormula: "{Trigger Spin} = TRUE()",
      maxRecords: 1
    });
    if (!records.length) return false;

    const rec = records[0];
    const spinId = rec.fields['Spin ID'] || rec.id;

    if (spinId === lastSpinIdSeen || appState.isSpinning) return false;

    lastSpinIdSeen = spinId;

    // immediately reset the trigger so other clients donâ€™t re-trigger
    await updateAirtableRecord(AIRTABLE_CONFIG.ADMIN_TABLE, rec.id, { 'Trigger Spin': false });

    return true;
  }catch(e){
    console.error('checkSpinTrigger error', e);
    return false;
  }
}

        async function markWinner(participant, position) {
            try {
                await updateAirtableRecord(AIRTABLE_CONFIG.PARTICIPANTS_TABLE, participant.id, {
                    Status: 'Winner'
                });
                console.log(`Marked ${participant.name} as winner`);
            } catch (error) {
                console.error('Error marking winner:', error);
                showError('Failed to mark winner in database');
            }
        }

        // ============================================================================
        // UI UPDATE FUNCTIONS
        // ============================================================================
        
        function createWheel(){
  const wheel = $('#wheel');
  wheel.empty();

  if (!appState.participants.length){
    wheel.css('background','conic-gradient(from 0deg, #1c2128, #2a3038)');
    return;
  }

  const segmentAngle = 360 / appState.participants.length;
  let stops = [];

  appState.participants.forEach((p, i) => {
    const start = i*segmentAngle;
    const mid = start + segmentAngle/2;
    const color = wheelColors[i % wheelColors.length];
    stops.push(`${color} ${start}deg ${(i+1)*segmentAngle}deg`);

    const isHighlighted = (userName && p.name===userName) || (userEmail && p.email===userEmail);

    const displayName = isHighlighted ? p.name : ''; // <<< hide others
    const numberDiv = $('<div class="wheel-number"></div>');
    numberDiv.html(`
      <div class="number-display ${isHighlighted?'highlighted':''}" style="--rotate:${mid}deg">${i+1}</div>
      <div class="participant-name ${isHighlighted?'highlighted':''}" style="--rotate:${mid}deg">${displayName}</div>
    `);
    wheel.append(numberDiv);
  });

  wheel.css('background',`conic-gradient(from 0deg, ${stops.join(', ')})`);
}

function updateParticipantsDisplay(){
  const grid = $('#participantsGrid');
  const count = $('#participantCount');
  const has = appState.participants.length;

  if (!has){
    grid.html(`<div style="grid-column:1/-1;text-align:center;color:#8a9199;padding:40px 20px;">Waiting for players to join...</div>`);
    count.text('0');
    return;
  }

  let html = '';
  appState.participants.forEach((p,i)=>{
    const isHighlighted = (userName && p.name===userName) || (userEmail && p.email===userEmail);
    html += `
      <div class="participant-slot ${isHighlighted?'highlighted':''}">
        <div class="slot-number">${i+1}</div>
        <div class="slot-name">${isHighlighted ? p.name : ''}</div>
      </div>`;
  });

  grid.html(html);
  count.text(has);
}

        function updateQueueDisplay() {
            const queueSection = $('#queueSection');
            const queueList = $('#queueList');
            const queueCount = $('#queueCount');
            
            if (appState.queue.length === 0) {
                queueSection.hide();
            } else {
                queueSection.show();
                let html = '';
                appState.queue.forEach((person, index) => {
                    html += `
                        <div class="queue-item">
                            <span>${person.name}</span>
                            <span class="queue-position">#${appState.participants.length + index + 1}</span>
                        </div>
                    `;
                });
                queueList.html(html);
            }
            
            queueCount.text(appState.queue.length);
        }

        function showUserBanner() {
            if (!appState.highlightedUser && !userEmail && !userName) return;
            
            const banner = $('#userBanner');
            const userNameSpan = $('#userName');
            const userNumberSpan = $('#userNumber');
            
            // Find user in participants
            let userIndex = -1;
            let displayName = appState.highlightedUser || userName || 'Player';
            
            if (userName || userEmail) {
                userIndex = appState.participants.findIndex(p => 
                    p.name === userName || p.email === userEmail
                );
            } else if (appState.highlightedUser) {
                userIndex = appState.participants.findIndex(p => p.name === appState.highlightedUser);
            }
            
            if (userIndex !== -1) {
                userNameSpan.text(displayName);
                userNumberSpan.text(userIndex + 1);
                banner.addClass('show');
            } else {
                banner.removeClass('show');
            }
        }

        function showWinnerAnnouncement(winner, position) {
            const announcement = $('#winnerAnnouncement');
            const winnerNumber = $('#winnerNumber');
            const winnerName = $('#winnerName');
            
            winnerNumber.text(position);
            winnerName.text(winner.name);
            
            announcement.addClass('show');
            createConfetti();
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                announcement.removeClass('show');
            }, 10000);
        }

        // ============================================================================
        // WHEEL SPINNING LOGIC - ADMIN ONLY (No manual spin capability)
        // ============================================================================
        
        function chooseWeightedIndex(list){
  // sum weights
  const total = list.reduce((s,p)=> s + (Number(p.weight)||1), 0);
  let r = Math.random() * total;
  for (let i=0;i<list.length;i++){
    r -= (Number(list[i].weight)||1);
    if (r <= 0) return i;
  }
  return list.length - 1; // fallback
}

let spinLockUntil = 0;        // prevents rapid/double spins
let rotationResetDone = true; // tracks reset state between spins

async function spinWheel(){
  const now = Date.now();
  if (appState.isSpinning || now < spinLockUntil || appState.participants.length===0) return;

  appState.isSpinning = true;
  spinLockUntil = now + 6000; // lock for > transition duration

  const wheel = $('#wheel');
  const indicator = $('#spinningIndicator');

  // Hard reset transform so every spin starts from 0deg
  rotationResetDone = false;
  wheel.css('transition','none');
  wheel.css('transform','rotate(0deg)');
  // force reflow so the browser applies the reset immediately
  void wheel[0].offsetWidth;
  rotationResetDone = true;

  // UI state
  indicator.addClass('show');
  $('.wheel-center').text('SPINNING');

  // --- weighted winner ---
  const winnerIndex = chooseWeightedIndex(appState.participants);
  const winner = appState.participants[winnerIndex];

  // --- compute rotation to land winner under the pointer at top (0deg) ---
  const segmentAngle = 360 / appState.participants.length;
  const targetAngle = winnerIndex * segmentAngle + segmentAngle/2; // center of segment
  const spins = 8; // full rotations
  const finalRotation = (spins*360) + (360 - targetAngle); // align winner at pointer

  // run spin
  wheel.addClass('spinning');
  wheel.css('transition','transform 4s cubic-bezier(0.25,0.46,0.45,0.94)');
  wheel.css('transform', `rotate(${finalRotation}deg)`);

  setTimeout(async ()=>{
    indicator.removeClass('show');
    $('.wheel-center').text('SPIN');
    wheel.removeClass('spinning');
    appState.isSpinning = false;

    await markWinner(winner, winnerIndex+1);
    showWinnerAnnouncement(winner, winnerIndex+1);

    setTimeout(refreshData, 1200);
  }, 4000);
}

        // ============================================================================
        // DATA REFRESH & POLLING
        // ============================================================================
        
        async function refreshData() {
            try {
                console.log('Refreshing data from Airtable...');
                
                // Fetch participants
                const allParticipants = await fetchParticipants();
                
                // Split into active participants (first 36) and queue
                appState.participants = allParticipants.slice(0, 36);
                appState.queue = allParticipants.slice(36);
                
                // Set highlighted user
                if (userName || userEmail) {
                    const user = allParticipants.find(p => 
                        p.name === userName || p.email === userEmail
                    );
                    if (user) {
                        appState.highlightedUser = user.name;
                    }
                }
                
                // Update UI
                createWheel();
                updateParticipantsDisplay();
                updateQueueDisplay();
                showUserBanner();
                
                updateConnectionStatus('connected');
                console.log(`Updated: ${appState.participants.length} participants, ${appState.queue.length} in queue`);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                updateConnectionStatus('error');
                showError('Failed to fetch data from Airtable');
            }
        }

let pollBusy = false;
async function pollForUpdates(){
  if (pollBusy) return;
  pollBusy = true;
  try{
    if (!appState.isSpinning){
      const shouldSpin = await checkSpinTrigger();
      if (shouldSpin){ spinWheel(); pollBusy = false; return; }
    }
    await refreshData();
  }catch(e){ console.error(e); }
  finally{ pollBusy = false; }
}

        // ============================================================================
        // EVENT HANDLERS & INITIALIZATION
        // ============================================================================
        
        $(document).ready(function() {
            console.log('Avoca Royale initializing...');
            console.log('User email:', userEmail);
            console.log('User name:', userName);
            console.log('Note: Manual spinning disabled - spins are admin-controlled only');
            
            // No manual spin capability - wheel center is display only
            $('#wheelCenter').css('cursor', 'default');
            
            // Close winner announcement on click
            $('#winnerAnnouncement').on('click', function() {
                $(this).removeClass('show');
            });
            
            // Initial data load
            refreshData();
            
            // Start polling loop
            setInterval(pollForUpdates, AIRTABLE_CONFIG.POLLING_INTERVAL);
            
            console.log('Avoca Royale initialized successfully');
        });

        // ============================================================================
        // DEBUG FUNCTIONS (for development/testing)
        // ============================================================================
        
        // Expose functions to global scope for debugging
        window.avocaDebug = {
            refreshData,
            spinWheel, // For testing only - normally only triggered by admin
            showError,
            appState,
            AIRTABLE_CONFIG
        };
        
        console.log('Debug functions available at window.avocaDebug');
    </script>
</body>
</html>
