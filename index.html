<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoca Royale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1c2128 0%, #2a3038 50%, #1c2128 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #f4f8ff;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 122, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 122, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        .casino-lights {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                #007aff 0%, #0056b3 25%, #007aff 50%, 
                #0056b3 75%, #007aff 100%);
            background-size: 200% 100%;
            animation: lights 3s linear infinite;
            box-shadow: 0 2px 20px rgba(0, 122, 255, 0.5);
        }

        @keyframes lights {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .header {
            text-align: center;
            margin: 40px 0 30px;
            z-index: 10;
            position: relative;
        }

        .header h1 {
            font-size: 4.5em;
            font-weight: 300;
            letter-spacing: 8px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f4f8ff 0%, #007aff 50%, #f4f8ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            text-shadow: 0 0 40px rgba(0, 122, 255, 0.3);
        }

        .subtitle {
            font-size: 1em;
            color: #8a9199;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 500;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            background: rgba(244, 248, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 122, 255, 0.3);
            border-radius: 30px;
            margin-top: 20px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .main-container {
            display: flex;
            gap: 50px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 1600px;
            z-index: 10;
            position: relative;
        }

        .roulette-table {
            background: linear-gradient(145deg, #242a32 0%, #1c2128 100%);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(0, 122, 255, 0.1),
                inset 0 1px 0 rgba(244, 248, 255, 0.05);
            position: relative;
        }

        .wheel-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .wheel-container {
            position: relative;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #1c2128 0%, #0f1114 100%);
            border-radius: 50%;
            padding: 20px;
            box-shadow: 
                inset 0 0 60px rgba(0, 0, 0, 0.8),
                0 0 80px rgba(0, 122, 255, 0.2);
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 0 40px rgba(0, 122, 255, 0.3),
                inset 0 0 30px rgba(0, 0, 0, 0.5);
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
            border: 2px solid rgba(244, 248, 255, 0.1);
        }

        .wheel-number {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: right bottom;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-display {
            position: absolute;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            border: 2px solid rgba(244, 248, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            color: #f4f8ff;
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.5),
                inset 0 -2px 5px rgba(0, 0, 0, 0.3);
            transform: rotate(var(--rotate)) translateX(180px) rotate(calc(-1 * var(--rotate)));
            transition: all 0.3s ease;
        }

        .number-display.highlighted {
            transform: rotate(var(--rotate)) translateX(180px) rotate(calc(-1 * var(--rotate))) scale(1.5);
            background: linear-gradient(135deg, #00d4ff 0%, #007aff 100%);
            box-shadow: 
                0 0 30px rgba(0, 212, 255, 0.8),
                0 2px 10px rgba(0,0,0,0.5),
                inset 0 -2px 5px rgba(0,0,0,0.3);
            animation: glow 1s ease-in-out infinite alternate;
            z-index: 100;
            border-color: #f4f8ff;
        }

        @keyframes glow {
            from { box-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 2px 10px rgba(0,0,0,0.5); }
            to { box-shadow: 0 0 50px rgba(0, 212, 255, 1), 0 2px 10px rgba(0,0,0,0.5); }
        }

        .participant-name {
            position: absolute;
            font-size: 10px;
            color: rgba(244, 248, 255, 0.7);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            transform: rotate(var(--rotate)) translateX(120px) rotate(calc(-1 * var(--rotate)));
            white-space: nowrap;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            transition: all 0.3s ease;
        }

        .participant-name.highlighted {
            font-size: 14px;
            font-weight: 600;
            color: #00d4ff;
            text-shadow: 
                0 0 10px rgba(0, 212, 255, 0.8),
                1px 1px 2px rgba(0,0,0,0.8);
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            border-radius: 50%;
            border: 3px solid rgba(244, 248, 255, 0.9);
            box-shadow: 
                0 0 40px rgba(0, 122, 255, 0.5),
                inset 0 -3px 10px rgba(0,0,0,0.3);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: #f4f8ff;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .wheel-center:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 
                0 0 60px rgba(0, 122, 255, 0.8),
                inset 0 -3px 10px rgba(0,0,0,0.3);
        }

        .pointer {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 50px solid #00d4ff;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
            z-index: 11;
            animation: bounce 2s infinite;
        }

        .pointer::after {
            content: '';
            position: absolute;
            top: -50px;
            left: -10px;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #00d4ff 0%, #007aff 100%);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .info-panels {
            display: flex;
            flex-direction: column;
            gap: 25px;
            min-width: 400px;
        }

        .panel {
            background: linear-gradient(145deg, #242a32 0%, #1c2128 100%);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 10px 40px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(244, 248, 255, 0.05);
            position: relative;
        }

        .panel h2 {
            margin-bottom: 25px;
            font-size: 1.5em;
            font-weight: 300;
            color: #f4f8ff;
            letter-spacing: 2px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(28, 33, 40, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(0, 122, 255, 0.1);
        }

        .participant-slot {
            background: linear-gradient(135deg, #2a3038 0%, #1c2128 100%);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .participant-slot:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 122, 255, 0.3);
            border-color: #007aff;
            background: linear-gradient(135deg, #2e343d 0%, #20252c 100%);
        }

        .participant-slot.highlighted {
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            border-color: #00d4ff;
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.6);
            animation: pulse-highlight 1s ease-in-out infinite;
        }

        @keyframes pulse-highlight {
            0%, 100% { transform: scale(1.1); }
            50% { transform: scale(1.15); }
        }

        .slot-number {
            font-size: 24px;
            font-weight: 600;
            color: #007aff;
            margin-bottom: 5px;
        }

        .slot-name {
            font-size: 11px;
            color: rgba(244, 248, 255, 0.8);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .participant-slot.highlighted .slot-number,
        .participant-slot.highlighted .slot-name {
            color: #f4f8ff;
        }

        .queue-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(28, 33, 40, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(0, 122, 255, 0.1);
        }

        .queue-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .queue-item {
            padding: 10px 18px;
            background: linear-gradient(135deg, #2a3038 0%, #1c2128 100%);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 25px;
            font-size: 14px;
            color: rgba(244, 248, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .queue-position {
            background: rgba(0, 122, 255, 0.2);
            color: #00d4ff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .winner-announcement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(145deg, #242a32 0%, #1c2128 100%);
            padding: 60px;
            border-radius: 30px;
            border: 2px solid #007aff;
            box-shadow: 
                0 30px 100px rgba(0,0,0,0.8),
                0 0 150px rgba(0, 122, 255, 0.4),
                inset 0 1px 0 rgba(244, 248, 255, 0.1);
            z-index: 1000;
            text-align: center;
            display: none;
        }

        .winner-announcement.show {
            display: block;
            animation: winnerPop 0.5s ease forwards;
        }

        @keyframes winnerPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(180deg); }
            60% { transform: translate(-50%, -50%) scale(1.1) rotate(-10deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }

        .winner-text {
            font-size: 1.2em;
            color: #8a9199;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 300;
        }

        .winner-number {
            font-size: 5em;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff 0%, #007aff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(0, 122, 255, 0.5);
            margin: 20px 0;
        }

        .winner-name {
            font-size: 2.5em;
            font-weight: 300;
            color: #f4f8ff;
            margin: 20px 0;
            letter-spacing: 2px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            position: absolute;
            animation: confetti-fall 3s linear;
        }

        @keyframes confetti-fall {
            0% { 
                transform: translateY(-100vh) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(100vh) rotate(720deg); 
                opacity: 0; 
            }
        }

        .spinning-indicator {
            display: none;
            background: linear-gradient(135deg, #00d4ff 0%, #007aff 100%);
            color: #f4f8ff;
            padding: 15px 40px;
            border-radius: 30px;
            position: absolute;
            bottom: -70px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 5px 30px rgba(0, 122, 255, 0.5);
            animation: pulse 1s infinite;
        }

        .spinning-indicator.show {
            display: block;
        }

        .user-highlight-banner {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            padding: 18px 40px;
            border-radius: 40px;
            border: 1px solid rgba(244, 248, 255, 0.3);
            box-shadow: 0 10px 40px rgba(0, 122, 255, 0.4);
            z-index: 1000;
            display: none;
            animation: slideDown 0.5s ease;
        }

        .user-highlight-banner.show {
            display: block;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .highlight-text {
            font-size: 1.1em;
            font-weight: 500;
            color: #f4f8ff;
            letter-spacing: 1px;
        }

        .highlight-number {
            font-size: 2em;
            margin: 0 15px;
            font-weight: 700;
            color: #f4f8ff;
            text-shadow: 0 0 10px rgba(244, 248, 255, 0.5);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(28, 33, 40, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #007aff 0%, #0056b3 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00d4ff 0%, #007aff 100%);
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="casino-lights"></div>
    
    <div class="header">
        <h1>Avoca Royale</h1>
        <div class="subtitle">Where Fortune Meets Destiny</div>
        <div class="status-indicator">
            <div class="status-dot"></div>
            <span id="connectionStatus">Connecting...</span>
        </div>
    </div>

    <div class="user-highlight-banner" id="userBanner">
        <div class="highlight-text">
            Your Number: <span class="highlight-number" id="userNumber">-</span>
            Good Luck, <span id="userName">Player</span>!
        </div>
    </div>

    <div class="main-container">
        <div class="roulette-table">
            <div class="wheel-section">
                <div class="wheel-container">
                    <div class="pointer"></div>
                    <div class="wheel" id="wheel"></div>
                    <div class="wheel-center">SPIN</div>
                    <div class="spinning-indicator" id="spinningIndicator">Spinning...</div>
                </div>
            </div>
        </div>

        <div class="info-panels">
            <div class="panel">
                <h2>Players (<span id="participantCount">0</span>/36)</h2>
                <div class="participants-grid" id="participantsGrid"></div>
                
                <div class="queue-section" id="queueSection" style="display: none;">
                    <h3 style="color: #f4f8ff; margin-bottom: 15px; font-weight: 300; letter-spacing: 1px;">WAITING LIST (<span id="queueCount">0</span>)</h3>
                    <div class="queue-list" id="queueList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="winner-announcement" id="winnerAnnouncement">
        <div class="winner-text">Winner</div>
        <div class="winner-number" id="winnerNumber">00</div>
        <div class="winner-name" id="winnerName"></div>
        <div style="font-size: 1.1em; color: #8a9199; margin-top: 20px; letter-spacing: 2px;">CONGRATULATIONS</div>
    </div>

    <script>
        // Configuration
        const AIRTABLE_API_KEY = 'patjFd8AqLFaguOEe.0926a467696986c2920b20907d6f7b8bc468592117c50e02d4303fbc29eb0ac1';
        const AIRTABLE_BASE_ID = 'appQm84VJgrmPJZal';
        const AIRTABLE_TABLE_NAME = 'Participants';
        const POLLING_INTERVAL = 2000;

        // State management
        let participants = [];
        let queue = [];
        let isSpinning = false;
        let highlightedUser = null;
        let lastSpinCheck = null;

        // Get URL parameters using jQuery
        const urlParams = new URLSearchParams(window.location.search);
        const userEmail = urlParams.get('email');
        const userName = urlParams.get('name');

        // Wheel segment colors (alternating dark blue and lighter variations)
        const wheelColors = [
            '#007aff', '#0056b3', '#003d80', '#004c99', 
            '#0066cc', '#0052a3', '#003366', '#004080',
            '#0059b3', '#003f7f', '#004d99', '#0066cc',
            '#007aff', '#0056b3', '#003d80', '#004c99',
            '#0066cc', '#0052a3', '#003366', '#004080',
            '#0059b3', '#003f7f', '#004d99', '#0066cc',
            '#007aff', '#0056b3', '#003d80', '#004c99',
            '#0066cc', '#0052a3', '#003366', '#004080',
            '#0059b3', '#003f7f', '#004d99', '#0066cc'
        ];

        // Initialize wheel
        function createWheel() {
            const wheel = $('#wheel');
            wheel.empty();
            
            if (participants.length === 0) {
                wheel.css('background', 'conic-gradient(from 0deg, #1c2128, #2a3038)');
                return;
            }

            const segmentAngle = 360 / participants.length;
            let gradientStops = [];
            
            participants.forEach((participant, index) => {
                const startAngle = index * segmentAngle;
                const endAngle = (index + 1) * segmentAngle;
                const color = wheelColors[index % wheelColors.length];
                
                gradientStops.push(`${color} ${startAngle}deg ${endAngle}deg`);
                
                // Create number display
                const numberDiv = $('<div class="wheel-number"></div>');
                numberDiv.html(`
                    <div class="number-display ${participant.isHighlighted ? 'highlighted' : ''}" 
                         style="--rotate: ${startAngle + segmentAngle/2}deg">
                        ${index + 1}
                    </div>
                    <div class="participant-name ${participant.isHighlighted ? 'highlighted' : ''}" 
                         style="--rotate: ${startAngle + segmentAngle/2}deg">
                        ${participant.name}
                    </div>
                `);
                wheel.append(numberDiv);
            });
            
            wheel.css('background', `conic-gradient(from 0deg, ${gradientStops.join(', ')})`);
        }

        // Update participants display
        function updateParticipantsDisplay() {
            const grid = $('#participantsGrid');
            const count = $('#participantCount');
            
            let html = '';
            participants.forEach((p, index) => {
                html += `
                    <div class="participant-slot ${p.isHighlighted ? 'highlighted' : ''}">
                        <div class="slot-number">${index + 1}</div>
                        <div class="slot-name">${p.name}</div>
                    </div>
                `;
            });
            
            grid.html(html);
            count.text(participants.length);
        }

        // Update queue display
        function updateQueueDisplay() {
            const queueSection = $('#queueSection');
            const queueList = $('#queueList');
            const queueCount = $('#queueCount');
            
            if (queue.length === 0) {
                queueSection.hide();
            } else {
                queueSection.show();
                let html = '';
                queue.forEach((name, index) => {
                    html += `
                        <div class="queue-item">
                            <span>${name}</span>
                            <span class="queue-position">#${participants.length + index + 1}</span>
                        </div>
                    `;
                });
                queueList.html(html);
            }
            
            queueCount.text(queue.length);
        }

        // Show user banner if they're highlighted
        function showUserBanner() {
            if (!highlightedUser) return;
            
            const banner = $('#userBanner');
            const userNameSpan = $('#userName');
            const userNumberSpan = $('#userNumber');
            
            const userIndex = participants.findIndex(p => p.isHighlighted);
            if (userIndex !== -1) {
                userNameSpan.text(highlightedUser);
                userNumberSpan.text(userIndex + 1);
                banner.addClass('show');
            }
        }

        // Fetch data from Airtable
        async function fetchAirtableData() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                processAirtableData(data.records);
                
                $('#connectionStatus').text('Connected');
                $('.status-dot').css('background', '#4ade80');
                
            } catch (error) {
                console.error('Error fetching Airtable data:', error);
                $('#connectionStatus').text('Connection Error');
                $('.status-dot').css('background', '#ff4444');
            }
        }

        // Check for spin trigger
        async function checkSpinTrigger() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Admin%20Controls?maxRecords=1&sort%5B0%5D%5Bfield%5D=Created%20Time&sort%5B0%5D%5Bdirection%5D=desc`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.records && data.records.length > 0) {
                        const record = data.records[0];
                        if (record.fields['Trigger Spin'] && record.id !== lastSpinCheck) {
                            lastSpinCheck = record.id;
                            if (!isSpinning && participants.length > 0) {
                                spinWheel();
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking spin trigger:', error);
            }
        }

        // Process Airtable data
        function processAirtableData(records) {
            const newParticipants = [];
            const newQueue = [];
            
            records.forEach((record, index) => {
                const fields = record.fields;
                
                if (fields.Name && fields.Status !== 'Inactive' && fields.Status !== 'Winner') {
                    const participant = {
                        name: fields.Name,
                        email: fields.Email || '',
                        weight: fields.Weight || 1,
                        isHighlighted: false
                    };
                    
                    // Check if this is the highlighted user
                    if (userEmail && fields.Email && fields.Email.toLowerCase() === userEmail.toLowerCase()) {
                        participant.isHighlighted = true;
                        highlightedUser = fields.Name;
                    } else if (userName && fields.Name && fields.Name.toLowerCase() === userName.toLowerCase()) {
                        participant.isHighlighted = true;
                        highlightedUser = fields.Name;
                    }
                    
                    if (index < 36) {
                        newParticipants.push(participant);
                    } else {
                        newQueue.push(fields.Name);
                    }
                }
            });
            
            // Update state
            participants = newParticipants;
            queue = newQueue;
            
            // Update displays
            updateParticipantsDisplay();
            updateQueueDisplay();
            createWheel();
            showUserBanner();
        }

        // Spin the wheel
        function spinWheel() {
            if (isSpinning || participants.length === 0) return;
            
            isSpinning = true;
            const wheel = $('#wheel');
            const spinIndicator = $('#spinningIndicator');
            
            spinIndicator.addClass('show');
            
            // Calculate weighted random winner
            const totalWeight = participants.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            let winnerIndex = 0;
            
            for (let i = 0; i < participants.length; i++) {
                random -= participants[i].weight;
                if (random <= 0) {
                    winnerIndex = i;
                    break;
                }
            }
            
            // Calculate rotation
            const segmentAngle = 360 / participants.length;
            const winnerAngle = winnerIndex * segmentAngle + segmentAngle / 2;
            const spins = 5 + Math.floor(Math.random() * 5);
            const finalRotation = spins * 360 + (360 - winnerAngle);
            
            wheel.css('transform', `rotate(${finalRotation}deg)`);
            
            // Show winner after spin
            setTimeout(() => {
                showWinner(participants[winnerIndex].name, winnerIndex + 1);
                spinIndicator.removeClass('show');
                isSpinning = false;
                
                // Create confetti
                createConfetti();
                
                // Update winner status in Airtable
                updateWinnerInAirtable(participants[winnerIndex].name);
            }, 4000);
        }

        // Update winner in Airtable
        async function updateWinnerInAirtable(winnerName) {
            try {
                // First, find the winner's record ID
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula={Name}='${winnerName}'`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.records && data.records.length > 0) {
                        const recordId = data.records[0].id;
                        
                        // Update the status to Winner
                        await fetch(
                            `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}/${recordId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    fields: {
                                        Status: 'Winner'
                                    }
                                })
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error updating winner:', error);
            }
        }

        // Show winner announcement
        function showWinner(name, number) {
            const announcement = $('#winnerAnnouncement');
            const winnerName = $('#winnerName');
            const winnerNumber = $('#winnerNumber');
            
            winnerName.text(name);
            winnerNumber.text(number);
            announcement.addClass('show');
            
            setTimeout(() => {
                announcement.removeClass('show');
                // Refresh data after winner announcement
                fetchAirtableData();
            }, 5000);
        }

        // Create confetti effect
        function createConfetti() {
            const colors = ['#007aff', '#00d4ff', '#f4f8ff', '#0056b3', '#8a9199'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = $('<div class="confetti"></div>');
                    confetti.css({
                        left: Math.random() * 100 + '%',
                        background: colors[Math.floor(Math.random() * colors.length)],
                        animationDelay: Math.random() * 1 + 's'
                    });
                    $('body').append(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        // Simulate data for demo (remove this in production)
        function simulateData() {
            const names = [
                'Alice Johnson', 'Bob Smith', 'Charlie Brown', 'Diana Prince', 
                'Ethan Hunt', 'Fiona Apple', 'George Lucas', 'Hannah Montana',
                'Ian McKellen', 'Julia Roberts', 'Kevin Hart', 'Lisa Simpson',
                'Mike Tyson', 'Nancy Drew', 'Oscar Wilde', 'Penny Lane'
            ];
            
            participants = names.slice(0, Math.min(16, names.length)).map((name, index) => ({
                name,
                email: `${name.toLowerCase().replace(' ', '.')}@example.com`,
                weight: Math.random() > 0.8 ? 3 : 1,
                isHighlighted: false
            }));
            
            // Check for highlighted user from URL params
            if (userName || userEmail) {
                participants.forEach(p => {
                    if (userEmail && p.email.toLowerCase() === userEmail.toLowerCase()) {
                        p.isHighlighted = true;
                        highlightedUser = p.name;
                    } else if (userName && p.name.toLowerCase() === userName.toLowerCase()) {
                        p.isHighlighted = true;
                        highlightedUser = p.name;
                    }
                });
                
                if (highlightedUser) {
                    showUserBanner();
                }
            }
            
            queue = names.slice(16);
            
            updateParticipantsDisplay();
            updateQueueDisplay();
            createWheel();
        }

        // Initialize
        $(document).ready(function() {
            // Start with fetching real data
            fetchAirtableData();
            
            // Set up polling
            setInterval(fetchAirtableData, POLLING_INTERVAL);
            setInterval(checkSpinTrigger, POLLING_INTERVAL);
            
            // For testing - uncomment to use simulated data
            // simulateData();
            
            // Demo spin button (remove in production - spins will be triggered from Airtable)
            $('.wheel-center').on('click', function() {
                if (!isSpinning) spinWheel();
            });
        });
    </script>
</body>
</html>
                